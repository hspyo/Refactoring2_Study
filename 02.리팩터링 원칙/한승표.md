# 리팩터링의 원칙

<br>

## 리팩터링의 정의
리팩터링의 정의는 단순히 코드를 정리하는 것이 아니다. 코드를 이해하고 수정하기 쉽게 만들기 위해 _**특정한 방식에 따라 코드를 정리하는 것만이 리팩터링이다**_. 리팩터링은 동작을 보존하는 작은 단계들을 거쳐 코드를 수정하고 이러한 단계들을 순차적으로 연결하여 큰 변화를 만들어내는 일이다.  

<br>

## 두 개의 모자
두 모자는 개발 목적을 비유한 것이다. _**우리는 개발을하면서 '기능 추가'와 '리팩터링' 두 목적을 잘 구분하면서 개발을 해야한다. 이 둘은 미묘한 작업 방식의 차이가 있기 때문이다.**_ 그러니 기능을 추가 작업을 할 때는 기능 추가에만 몰두하고, 리팩터링할 때는 코드 재구성에만 오로지 신경써야한다. 기능을 추가하다보면 다른 고치고 싶은 코드베이스가 보일 때가 빈번하다. 계속 옆길로 새다보면 어느 작업하나 제대로 마무리가 안되기도 하고 머릿속이 복잡해진다. 비교적 자유로운 환경에서 개발하는 개인프로젝트를 할 때 이런 경험을 몇번 했다. 이 작업 저 작업하다보면 어느 하나 마무리 되는게 없어서 성취감도 없고 최악의 경우에는 코드도 복잡해져 골머리를 앓았다. _**하지만 하나 명심할 것은 저자가 말하길 두 모자 사이를 오갈 수 있는 유연함도 때때로 필요하다고 한다.**_ 예를들어 구조를 먼저 바꾸고 새로운 기능을 추가하는게 더 낫다고 판단되는 경우다. 따라서 목적을 인식하고 그에 맞게 개발을 하되, 언제든 상황에 따라 목적을 변경하고 작업을 할 수 있어야한다. 유연함은 분명히 더 효율적인 프로그래밍을 가능하게 해준다.

<br>

## 리팩터링을 하는 이유는 뭘까
1. 소프트웨어의 설계가 좋아진다.
2. 소프트웨어를 이해하기 쉬워진다.
3. 버그를 쉽게 찾을 수 있다.
4. 시간이 지날 수록 작업의 속도는 빨라진다.

<br>

## 언제 리팩터링을 해야할까
리팩터링은 따로 시간을 빼기 보다 작업 흐름에 녹이는 게 좋다. 3의 법칙을 기억하자.
1. 처음에는 그냥 한다.
2. 비슷한 일을 두 번째로 하게되면, 일단 계속한다.
3. 비슷한 일을 세 번째로 하게 되면 리팩터링 한다.  

즉 삼진아웃되면 리팩터링 한다. 이를 염두하고 리팩터링 타이밍을 알아보자.  

- 기능 추가 전  
리팩터링을 하기 가장 좋은 시점이 기능을 새로 추가하기 직전이다. 중복코드가 생길 여지가 없는지 혹은 로직을 분리할 것은 없는지 등등 새 작업 직전에 하는 것이다.

- 코드를 파악할 때  
코드를 수정하려면 일단 코드를 파악해야되는데 이 때 의도가 더 명확하게 들어나도록 리팩터링할 여지가 없는지 살펴본다. 조건부 로직, 변수명, 함수명, 긴함수를 잘게 나누기 등등.

- 하던 작업을 끝내고 나중에  
코드를 파악할 때, 시간이 좀 걸릴거 같은 일은 메모해두었다가 작업을 마치고 한다.

- 리팩터링은 별개의 활동이 아니다.  
계획하고 리팩터링을 할 수도 있지만 작업을 하면서 기회가 될때마다 드러나지 않게 한다. 계획된 리팩터링의 치명적인 단점은 계획된 시점까지 코드가 곪다가 터질 수 있는 리스크가 존재한다.

- 점진적인 개선  
큰 작업의 경우에는 한번에 몰아서 하는 것보다 리팩터링해야하는 코드와 관련 있는 작업이 있을 때마다 몇주에 걸쳐 천천히 해나가는 것이 효율적이다.

- 코드 리뷰를 하면서  
코드 리뷰는 다른 사람의 아이디어를 얻을 수 있는 기회이다. 여기서 한발 더 나아가 다른 동료의 코드를 코멘트에서 끝내는게 아니라 직접 리팩터링해볼 수 있다. 직접해보면 한 차원 더 높은 아이디어가 떠오르기도 한다.

- 리팩터링을 하지 말아야할 때  
 - 외부 API 다루듯 호출해서 쓰는 코드
 - 리팩터링보다 새로 작성하는게 나을 때 (판단이 쉽지는 않음)

<br>

## 리팩터링시 고려할 문제들

![Untitled](https://user-images.githubusercontent.com/53952734/142715491-0d34b82a-e68e-4be0-a566-5fdeb63a00e8.png)
###### <p align="center" >출처: martinfowler.com</p>  

<br>

- 새 기능 개발 속도 저하  
위 그래프처럼 리팩터링의 궁극적인 목적은 개발 속도를 높여서, 더 적은 노력으로 더 많은 가치를 창출하는 것이다. 하지만 그렇더라도 상황에 맞게 조율해야한다. 추가할 기능이 아주 작아서 일단 기능 추가부터 하는 게 낫다고 생각될 경우, 불편정도가 매우 적을 경우, 당장 해결방법이 떠오르지 않을 경우 등등 이러한 경우에는 리팩터링을 나중에 하거나 하지 않는게 나을 수 있다.

- 코드 소유권  
코드 소유권은 작은 단위로 나눠 관리하는 것보다 느슨하게 관리하는 것이 효율적이다. 즉 내가 담당한 이외에 코드를 전혀 수정할 수 없다면 쉽게 해결할 문제들을 어렵게 해결하게 될 수 있다.

- 브랜치  
독립 브랜치로 작업하는 기간이 길어질수록 작업 결과를 마스터로 통합하기가 어렵다. 최소 머지를 하루에 한번은 하면서 지속적인 통합(CI)을 해주어야한다.

- 테스팅   
자가 테스트 코드를 만드는 것은 노력이 필요하지만 효과는 상당하다. 리팩터링이나 기능 추가를 안전하게 하도록 돕는다. 테스트가 실패하면 최근에 통과한 버전에서 무엇이 달라졌는지 살펴볼 수 있어 버그를 빠르게 찾아서 제거할 수 있다.

- 레거시 코드  
레커시 코드를 개선하는 것은 쉽지 않지만 이 또한 테스트 보강을 통해 점진적으로 개선해야한다.

<br>

## 리팩터링과 소프트웨어 개발 프로세스
_**자가 테스트 코드, 지속적 통합, 리팩터링이라는 세 기법이 조화를 이룰 때 효과적으로 소프트웨어를 만들 수 있다.**_ 또한 유연성 메커니즘을 갖춘 시스템보다는 단순한 시스템이 변경하기 쉽다. 유연성 메커니즘이란 가령 함수를 정의하다 보면 범용적으로 사용할 수 있겠다는 생각이 들어, 다양한 시나리오에 대응하기 위해 여러 매개변수를 추가하는 것이다. 이보다는 리팩터링을 통해 현재까지 파악한 요구사항만을 멋지게 해결하도록 단순하게 설계하는 것이 더 낫다는 것이다.

<br>

## 리팩터링과 성능
직관적인 설계 vs 성능 은 중요한 주제이다. 실제로 리팩터링을 하다보면 성능이 느려질 수 있다. _**하지만 소프트웨어를 빠르게 만들기 위해서는 튜닝하기 쉽게 만들고 그 다음 빠르게 만드는 순서가 되어야한다.**_
성능에 관한 흥미로운 사실은 전체 코드 중 극히 일부에서 대부분의 시간을 소비한다는 것이다. 그래서 전체 코드를 고르게 최적화하는 것 보다 일부 코드를 개선하는 것이 효과적이다. 그러기 위해서는 분석을 통해 시간과 공간을 많이 잡아 먹는 부분을 찾아내야 한다. 즉 단기적으로 보면 리팩터링은 성능을 느리게 만드는게 사실이지만 멀리보면 나중에 최적화 단계에서 코드를 튜닝하기 훨씬 쉬워 더 빠른 소프트웨어를 얻게 된다.

<br>

## 마치며  
이번 챕터에서 던지는 핵심메시지는 _**리팩터링은 특정한 방식에 따라 코드를 정리하는 것이고, 리팩토링의 누적은 결국 소프트웨어를 명확하고 빠르게 생산할 수 있도록 도와준다는 내용이다.**_ 여기서 빠지기 쉬운 오류는 '클린 코드' 나 '좋은 개발 습관' 처럼 도덕적인 것으로 리팩터링이 치부되는 것이다. 리팩터링은 도덕적인 이유로 정당화되는 것이 아니라는 문장이 인상 깊었다. 리팩터링은 필수지만 상황이나 코드에 따라 리팩터링 진행 여부를 잘 판단해야한다. 더 이상 필요없게 될 코드는 리팩터링을 하지 않거나 새로 코드를 작성하는 경우가 나을 때도 있다. 다시 말해 누적되지 않을 리팩토링은 생략한다. 비지니스 환경에서는 시간은 제한적이기에.  
&nbsp;&nbsp;이 외에 유익했던 부분은 필자의 경험상, 대부분의 경우 성능을 개선할 때 전체적으로 고르게 코드를 수정하는 것보다 전체중에 느려지게 만드는 부분을 찾아서 그 부분을 개선하는 것이 효과가 압도적이라는 것이다. 또한 유연성 메커니즘을 갖춘 시스템보다는 단순한 시스템이 변경하기 쉽다는 내용을 보면서 유연성 메커니즘 방식으로 작업했던 과거가 떠올랐다. 지금은 그렇게 작성하지 않지만, 하나의 함수를 유연하게 만들기 위해서 매개변수를 여럿 추가해서 작성한 던 때가 있었다. 그 당시엔 그저 코드 중복을 줄이겠다는 일차원적인 판단을 했다. 코드가 짧아지긴했지만 수정하기 매우 힘들었다. 이러한 유연성 메커니즘 방식은 변화에 대응하기 어려운 구조인 것을 책을 통해 다시 확인했다.
&nbsp;&nbsp; 리팩터링을 능숙하게 하기 위해서는 충분한 경험과 노력이 뒷받침되어야 하는 게 사실이다. 그렇다고해서 미뤄야할 것은 아니다. 당장 할 수 있는 것들부터 시도해나가고 스스로에게 녹여내려는 시도를 하면서 경험치를 쌓아야겠다는 생각이 들었다. 이론만큼 연습이 중요한 부분이라는 생각이 들었다. 리팩터링은 오랜 숙제이다.
  
